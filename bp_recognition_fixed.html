<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡€å£“è¨ˆå½±åƒè¾¨è­˜èˆ‡è¨˜éŒ„</title>
    <style>
        /* ç¹¼æ‰¿è‡ªæ‚¨çš„å€‹äººé é¢æ¨£å¼ */
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background-color: #f8f4e6; /* æ·¡ç±³ç™½è‰²èƒŒæ™¯ */
            color: #333;
            text-align: center;
        }
        .container {
            max-width: 800px;  
            margin: auto;
            background: #f0ffef; /* èª¿æ•´ç‚ºæ›´æ·ºçš„èƒŒæ™¯è‰² */
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #5a5a5a;
        }
        h2, h3 { /* å¢åŠ  h3 æ¨£å¼ */
            color: #007bff; /* è—è‰²ä¸»è‰² */
            margin-top: 25px;
        }
        p {
            line-height: 1.6;
        }

        /* === è¿”å›æŒ‰éˆ•æ¨£å¼ (ç¹¼æ‰¿è‡ªåŸé é¢) === */
        .back-button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            display: block;  
            width: 150px;
            margin: 0 0 20px 0;  
            text-align: center;
            transition: background-color 0.3s;
        }
        .back-button:hover {
            background-color: #0056b3;
        }
        
        /* === å°ˆå±¬æ¨£å¼ Start === */
        
        /* åœ–ç‰‡ä¸Šå‚³å€åŸŸ */
        #image-upload-area {
            border: 3px dashed #007bff; /* ä½¿ç”¨è—è‰²è™›ç·šæ¡† */
            background-color: #e6f7ff; /* æ¥µæ·ºè—è‰²èƒŒæ™¯ */
            padding: 25px;
            margin: 20px auto;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #image-upload-area:hover {
            background-color: #cceeff;
        }

        /* éš±è—åŸç”Ÿæª”æ¡ˆè¼¸å…¥æ¡† */
        #fileInput {
            display: none;
        }

        /* åœ–ç‰‡é è¦½æ¡† (æ²¿ç”¨ cam-frame çš„è¦–è¦ºé¢¨æ ¼) */
        #image-preview {
            max-width: 100%;
            max-height: 350px;
            margin: 20px auto;
            border: 4px solid #333; /* æ·±è‰²é‚Šæ¡† */
            border-radius: 4px;
            display: none; /* é è¨­éš±è— */
            object-fit: contain;
            background-color: #000;
        }
        
        /* çµæœå±•ç¤ºå€ */
        .result-box {
            background: #fff;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .result-box strong {
            font-size: 1.5em;
            color: #ff6600; /* ä½¿ç”¨æ©™è‰²çªå‡ºçµæœ */
        }

        /* åŠŸèƒ½æŒ‰éˆ• (è¾¨è­˜/å„²å­˜) */
        .action-button {
            background-color: #ff6600; /* æ©™è‰²æŒ‰éˆ•ï¼Œç”¨æ–¼ä¸»è¦å‹•ä½œ */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            margin: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .action-button:hover:not(:disabled) {
            background-color: #cc5200;
        }

        .action-button:disabled {
            background-color: #5a5a5a; /* é—œé–‰ç‹€æ…‹çš„ç°è‰² */
            cursor: not-allowed;
        }
        
        /* è£å‰ªé è¦½å€æ¨£å¼ */
        #crop-preview-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 10px;
            border: 1px dashed #007bff;
            padding: 10px;
            background-color: #eaf8ff;
            border-radius: 5px;
        }
        .digit-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 5px;
        }
        .digit-preview canvas {
            border: 2px solid #555;
            border-radius: 3px;
        }


        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 680px) {
            .container {
                margin: 0;
            }
            #image-preview {
                width: 100%;
            }
        }
        /* === å°ˆå±¬æ¨£å¼ End === */

    </style>
</head>
<body>
    <div class="container">
        
        <button class="back-button" onclick="history.back()">
            â† è¿”å›ä¸Šä¸€é 
        </button>
        
        <h1>è¡€å£“è¨ˆå½±åƒè¾¨è­˜èˆ‡æ•¸æ“šè¨˜éŒ„</h1>
        
        <p>è«‹ä¸Šå‚³è¡€å£“è¨ˆé¡¯ç¤ºå±çš„åœ–ç‰‡ã€‚</p>
        <hr>

        <div class="recognition-section">
            <h2>ä¸Šå‚³åœ–ç‰‡</h2>
            
            <input type="file" id="fileInput" accept="image/*" onchange="previewImage()">
            
            <div id="image-upload-area" onclick="document.getElementById('fileInput').click()">
                <p>é»æ“Šä¸Šå‚³è¡€å£“è¨ˆåœ–ç‰‡</p>
            </div>
            
            <img id="image-preview" src="#" alt="ä¸Šå‚³çš„åœ–ç‰‡é è¦½">
            
            <button class="action-button" id="predict-button" onclick="predict()" disabled>
                ğŸ§  é–‹å§‹è¾¨è­˜æ•¸å€¼
            </button>
            <p style="font-size: 0.9em; color: #888;">è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼Œå†é»æ“Šé–‹å§‹è¾¨è­˜ã€‚</p>
            <hr>

            <h3>ğŸ” è£å‰ªé è¦½ (é™¤éŒ¯ç”¨)</h3>
            <div id="crop-preview-container">
                <p style="color: #888; font-style: italic;">é»æ“Šã€Œé–‹å§‹è¾¨è­˜ã€å¾Œï¼Œé€™è£¡å°‡é¡¯ç¤ºè£å‰ªå¾Œçš„æ•¸å­—ã€‚</p>
            </div>
            <hr>
            <h2>è¾¨è­˜çµæœèˆ‡è¨˜éŒ„</h2>
            
            <div class="result-box">
                <p>æ”¶ç¸®å£“ (Systolic): <strong id="systolic-result">---</strong> mmHg</p>
                <p>èˆ’å¼µå£“ (Diastolic): <strong id="diastolic-result">---</strong> mmHg</p>
            </div>
            
            <button class="action-button" id="save-button" onclick="saveToSheet()" disabled>
                ğŸ’¾ è¨˜éŒ„åˆ° Google Sheet
            </button>

        </div>

    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    
    <script>
// ----------------------------------------------------------------------
// ã€æ ¸å¿ƒè¨­å®šå€ã€‘
// ----------------------------------------------------------------------
// ğŸš¨ 1. Teachable Machine æ¨¡å‹çš„ URL (å·²æ›´æ–°ç‚ºæ‚¨çš„ç¶²å€) ğŸš¨
const URL = "https://teachablemachine.withgoogle.com/models/UGwLtPbgm/"; 

// ã€æ–°å¢ã€‘æ¨™æº–åŒ–è™•ç†å°ºå¯¸ (åŸºæ–¼æ‚¨çš„åœ–ç‰‡æ¯”ä¾‹ï¼Œå¯¬åº¦è¨­ç‚º 800)
const STANDARD_WIDTH = 800;  
const STANDARD_HEIGHT = 600; 

// ğŸš¨ 2. è£å‰ªå€åŸŸå®šç¾© (å·²æ›´æ–°ç‚ºåŸºæ–¼ IMG_5554.jpg çš„å¾®èª¿åº§æ¨™) ğŸš¨
// é‡å°åœ–ç‰‡ IMG_5554.jpg (è®€æ•¸ 110/59) é€²è¡Œå„ªåŒ–
const CROP_AREAS = [
    // æ”¶ç¸®å£“ (Systolic) - å·¦ä¸Šè§’ (æ•¸å­— 110)
    { id: "SYS_1", type: "S", x: 38, y: 104, w: 108, h: 160 },   // ç¬¬ä¸€ä½ (1)
    { id: "SYS_2", type: "S", x: 150, y: 104, w: 108, h: 160 },  // ç¬¬äºŒä½ (1)
    { id: "SYS_3", type: "S", x: 262, y: 104, w: 108, h: 160 },  // ç¬¬ä¸‰ä½ (0)

    // èˆ’å¼µå£“ (Diastolic) - å³ä¸Šè§’ (æ•¸å­— 59)
    { id: "DIA_1", type: "D", x: 540, y: 104, w: 108, h: 160 },  // ç¬¬ä¸€ä½ (5)
    { id: "DIA_2", type: "D", x: 652, y: 104, w: 108, h: 160 },  // ç¬¬äºŒä½ (9)

    // è„ˆæ (Pulse) - å³ä¸‹è§’ (æ•¸å­— 74)
    // { id: "PUL_1", type: "P", x: 428, y: 400, w: 108, h: 160 }, // è„ˆæ (Pulse) ç¬¬ä¸€ä½ (7)
    // { id: "PUL_2", type: "P", x: 540, y: 400, w: 108, h: 160 }, // è„ˆæ (Pulse) ç¬¬äºŒä½ (4)
];
// ----------------------------------------------------------------------

        let model, maxPredictions;
        const DEFAULT_VALUE = "---";  
        
        // å»ºç«‹ä¸€å€‹éš±è—çš„ Canvas ä¾›è£å‰ªå’Œé æ¸¬ä½¿ç”¨ (å°ºå¯¸å›ºå®šç‚ºæ¨¡å‹è¼¸å…¥ 224x224)
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = 224;  
        tempCanvas.height = 224;
        const tempCtx = tempCanvas.getContext('2d');
        

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–æ¨¡å‹
        async function init() {
            try {
                const modelURL = URL + "model.json";
                const metadataURL = URL + "metadata.json";

                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();
                
                document.getElementById('systolic-result').innerText = DEFAULT_VALUE;
                document.getElementById('diastolic-result').innerText = DEFAULT_VALUE;
                console.log("Teachable Machine æ¨¡å‹è¼‰å…¥å®Œæˆã€‚");
                
            } catch (error) {
                console.error("æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ URL åŠæª”æ¡ˆè·¯å¾‘: ", error);
                document.getElementById('systolic-result').innerText = "è¼‰å…¥å¤±æ•—";  
                document.getElementById('diastolic-result').innerText = "è¼‰å…¥å¤±æ•—";
                alert("AIæ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Teachable Machine URL å’Œæª”æ¡ˆè·¯å¾‘æ˜¯å¦æ­£ç¢ºã€‚");
            }
        }

        // åœ–ç‰‡ä¸Šå‚³é è¦½ (é‚è¼¯ä¸è®Š)
        function previewImage() {
            const fileInput = document.getElementById('fileInput');
            const preview = document.getElementById('image-preview');
            const file = fileInput.files[0];

            document.getElementById("predict-button").disabled = true;  
            document.getElementById("save-button").disabled = true;
            document.getElementById("predict-button").innerText = "ğŸ§  é–‹å§‹è¾¨è­˜æ•¸å€¼";
            document.getElementById("crop-preview-container").innerHTML = '<p style="color: #888; font-style: italic;">é»æ“Šã€Œé–‹å§‹è¾¨è­˜ã€å¾Œï¼Œé€™è£¡å°‡é¡¯ç¤ºè£å‰ªå¾Œçš„æ•¸å­—ã€‚</p>'; // æ¸…ç©ºè£å‰ªé è¦½å€

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    document.getElementById("predict-button").disabled = false;  
                    document.getElementById("systolic-result").innerText = DEFAULT_VALUE;
                    document.getElementById("diastolic-result").innerText = DEFAULT_VALUE;
                }
                reader.readAsDataURL(file);
            }
        }

        // æ ¸å¿ƒè¾¨è­˜å‡½å¼ (å·²æ•´åˆå›ºå®šå°ºå¯¸ç¸®æ”¾å’Œæ–°åº§æ¨™)
        async function predict() {
            document.getElementById("predict-button").innerText = "è¾¨è­˜ä¸­...";
            document.getElementById("predict-button").disabled = true;
            document.getElementById("systolic-result").innerText = "åˆ†æä¸­...";
            document.getElementById("diastolic-result").innerText = "åˆ†æä¸­...";
            document.getElementById("save-button").disabled = true;

            if (!model) {
                alert("æ¨¡å‹å°šæœªè¼‰å…¥æˆåŠŸï¼Œç„¡æ³•è¾¨è­˜ã€‚");
                document.getElementById("predict-button").innerText = "ğŸ§  æ¨¡å‹æœªè¼‰å…¥";
                document.getElementById("predict-button").disabled = false;
                document.getElementById("systolic-result").innerText = "è¼‰å…¥å¤±æ•—";
                document.getElementById("diastolic-result").innerText = "è¼‰å…¥å¤±æ•—";
                return;
            }

            const image = document.getElementById('image-preview');
            if (!image.src || image.src.includes('#')) {
                alert("è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼");
                document.getElementById("predict-button").innerText = "ğŸ§  é–‹å§‹è¾¨è­˜æ•¸å€¼";
                document.getElementById("predict-button").disabled = false;
                document.getElementById("systolic-result").innerText = DEFAULT_VALUE;
                document.getElementById("diastolic-result").innerText = DEFAULT_VALUE;
                return;
            }

            // 1. å»ºç«‹ä¸€å€‹ Canvasï¼Œä¸¦å¼·åˆ¶å°ºå¯¸ç‚º STANDARD_WIDTH x STANDARD_HEIGHT
            const originalCanvas = document.createElement('canvas');
            originalCanvas.width = STANDARD_WIDTH;    // 800
            originalCanvas.height = STANDARD_HEIGHT; // 600
            const originalCtx = originalCanvas.getContext('2d');

            // ç¹ªè£½åœ–ç‰‡æ™‚ï¼Œå°‡å…¶ç¸®æ”¾åˆ°æ¨™æº–å°ºå¯¸ã€‚é€™ç¢ºä¿äº†è£å‰ªåº§æ¨™çš„æº–ç¢ºæ€§ã€‚
            originalCtx.drawImage(image, 0, 0, STANDARD_WIDTH, STANDARD_HEIGHT);
            
            let systolicStr = "";
            let diastolicStr = "";
            let isSuccessful = true;
            
            // æ¸…ç©ºè£å‰ªé è¦½å€
            document.getElementById("crop-preview-container").innerHTML = '';
            
            try {
                for (const area of CROP_AREAS) {
                    // 2. è£å‰ªå–®å€‹æ•¸å­—çš„å€åŸŸ (ä½¿ç”¨æ¨™æº–åŒ–å¾Œçš„ Canvas é€²è¡Œè£å‰ª)
                    // å¾æ¨™æº–åŒ–å¾Œçš„åœ–ç‰‡ä¸­æŠ“å–åƒç´ æ•¸æ“š
                    const croppedImageData = originalCtx.getImageData(area.x, area.y, area.w, area.h);
                    
                    // è‡¨æ™‚ Canvas ç”¨æ–¼ä¿å­˜è£å‰ªå¾Œçš„å–®å€‹æ•¸å­—
                    const digitCanvas = document.createElement('canvas');
                    digitCanvas.width = area.w;
                    digitCanvas.height = area.h;
                    // å°‡è£å‰ªæ•¸æ“šæ”¾é€² digitCanvas
                    digitCanvas.getContext('2d').putImageData(croppedImageData, 0, 0);

                    // ğŸš¨ è¦–è¦ºåŒ–é™¤éŒ¯ï¼šå°‡è£å‰ªå¾Œçš„ Canvas é¡¯ç¤ºåœ¨ç¶²é ä¸Š ğŸš¨
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'digit-preview';
                    previewDiv.innerHTML = `<p style="font-size: 0.8em; margin: 2px 0;">${area.id}</p>`;
                    previewDiv.appendChild(digitCanvas);
                    document.getElementById("crop-preview-container").appendChild(previewDiv);


                    // 4. åŸ·è¡Œé æ¸¬ï¼šæ¨¡å‹æœƒè‡ªå‹•å°‡ digitCanvas (ä¾‹å¦‚ 108x160) ç¸®æ”¾ç‚º 224x224 é€²è¡Œé æ¸¬
                    const prediction = await model.predict(digitCanvas);

                    // æ‰¾å‡ºä¿¡å¿ƒåº¦æœ€é«˜çš„é¡åˆ¥
                    const highestPrediction = prediction.reduce((prev, current) =>  
                        (prev.probability > current.probability) ? prev : current
                    );
                    
                    const predictedClassName = highestPrediction.className;  
                    
                    // ğŸš¨ 5. çµ„è£æ•¸å€¼ - é—œéµä¿®æ­£ï¼šå¾é¡åˆ¥åç¨±ä¸­æå–ç´”æ•¸å­— ğŸš¨
                    const actualDigit = predictedClassName.replace('Number_', '').trim();
                    
                    if (actualDigit !== undefined && highestPrediction.probability > 0.65) { // è¨­ç½®ä¿¡å¿ƒåº¦é–¾å€¼ç‚º 0.65
                        if (area.type === "S") {
                            systolicStr += actualDigit;
                        } else if (area.type === "D") {
                            diastolicStr += actualDigit;
                        }
                        // é¡å¤–è¼¸å‡ºä¿¡å¿ƒåº¦åˆ° Console
                        console.log(`[${area.id}] é æ¸¬: ${actualDigit} (ä¿¡è³´åº¦: ${(highestPrediction.probability * 100).toFixed(1)}%)`);

                    } else {
                        console.warn(`è¾¨è­˜é …ç›® ${area.id} ä¿¡å¿ƒåº¦ä¸è¶³ (${(highestPrediction.probability * 100).toFixed(1)}%)ï¼Œè¨­ç‚ºå¤±æ•—ã€‚`);
                        isSuccessful = false;
                        break;  
                    }
                }

            } catch (error) {
                console.error("è¾¨è­˜éç¨‹ç™¼ç”ŸéŒ¯èª¤:", error);
                isSuccessful = false;
            }

            // 6. é¡¯ç¤ºçµæœ
            const finalSystolic = isSuccessful && systolicStr.length > 0 ? systolicStr : DEFAULT_VALUE;
            const finalDiastolic = isSuccessful && diastolicStr.length > 0 ? diastolicStr : DEFAULT_VALUE;

            document.getElementById("systolic-result").innerText = finalSystolic;
            document.getElementById("diastolic-result").innerText = finalDiastolic;

            // æ¢å¾©æŒ‰éˆ•
            const successText = `âœ… è¾¨è­˜æˆåŠŸ (${finalSystolic}/${finalDiastolic})`;
            const failureText = `âŒ è¾¨è­˜å¤±æ•—ï¼Œè«‹é‡è©¦`;
            document.getElementById("predict-button").innerText = isSuccessful && finalSystolic !== DEFAULT_VALUE ? successText : failureText;
            document.getElementById("predict-button").disabled = false;
            
            // å•Ÿç”¨/ç¦ç”¨å„²å­˜æŒ‰éˆ•
            if (finalSystolic !== DEFAULT_VALUE && finalDiastolic !== DEFAULT_VALUE) {
                document.getElementById("save-button").disabled = false;
            } else {
                document.getElementById("save-button").disabled = true;
            }
        }

        // è³‡æ–™å¯«å…¥ Google Sheet å‡½å¼ (é‚è¼¯ä¸è®Š)
        function saveToSheet() {
            const systolicRaw = document.getElementById("systolic-result").innerText.trim();
            const diastolicRaw = document.getElementById("diastolic-result").innerText.trim();

            const systolic = Number(systolicRaw);  
            const diastolic = Number(diastolicRaw);  

            if (systolicRaw === DEFAULT_VALUE || diastolicRaw === DEFAULT_VALUE || isNaN(systolic) || isNaN(diastolic)) {
                alert("è¾¨è­˜æ•¸å€¼ç„¡æ•ˆæˆ–æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•å„²å­˜ã€‚");
                return;
            }

            document.getElementById("save-button").innerText = "å„²å­˜ä¸­...";
            document.getElementById("save-button").disabled = true;
            
            // ğŸš¨ è«‹æ›¿æ›ç‚ºæ‚¨ Google Apps Script çš„ Web App URL ğŸš¨
            const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyRizxiYrgd2WDhDLLeU1-UrkIiWkFTwHcHf8ANkyCDTnET1mhfbXLQwpfQn3-tZsFL/exec'; 
            
            const data = {
                'timestamp': new Date().toLocaleString(),
                'systolic': systolic,  
                'diastolic': diastolic
            };

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',  
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(() => {
                setTimeout(() => {
                    alert("è¡€å£“æ•¸æ“šå·²æˆåŠŸè¨˜éŒ„åˆ° Google Sheetï¼");
                    document.getElementById("save-button").innerText = "ğŸ’¾ è¨˜éŒ„å®Œæˆ";
                    document.getElementById("save-button").disabled = true;
                }, 500); 

            })
            .catch(error => {
                console.error('è¨˜éŒ„å¤±æ•—:', error);
                alert("æ•¸æ“šè¨˜éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– Apps Script URLã€‚");
                document.getElementById("save-button").innerText = "ğŸ’¾ è¨˜éŒ„å¤±æ•—";
                document.getElementById("save-button").disabled = false;
            });
        }

        // å•Ÿå‹•æ¨¡å‹è¼‰å…¥
        init();
    </script>
</body>
</html>
