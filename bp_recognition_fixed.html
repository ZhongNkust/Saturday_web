<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡€å£“è¨ˆå½±åƒè¾¨è­˜èˆ‡è¨˜éŒ„</title>
    <style>
        /* ç¹¼æ‰¿è‡ªæ‚¨çš„å€‹äººé é¢æ¨£å¼ */
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background-color: #f8f4e6; /* æ·¡ç±³ç™½è‰²èƒŒæ™¯ */
            color: #333;
            text-align: center;
        }
        .container {
            max-width: 800px;  
            margin: auto;
            background: #f0f8ff; /* æ·¡è—ç™½è‰²å®¹å™¨èƒŒæ™¯ */
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #5a5a5a;
        }
        h2 {
            color: #007bff; /* è—è‰²ä¸»è‰² */
            margin-top: 25px;
        }
        p {
            line-height: 1.6;
        }

        /* === è¿”å›æŒ‰éˆ•æ¨£å¼ (ç¹¼æ‰¿è‡ªåŸé é¢) === */
        .back-button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            display: block;  
            width: 150px;
            margin: 0 0 20px 0;  
            text-align: center;
            transition: background-color 0.3s;
        }
        .back-button:hover {
            background-color: #0056b3;
        }
        
        /* === å°ˆå±¬æ¨£å¼ Start === */
        
        /* åœ–ç‰‡ä¸Šå‚³å€åŸŸ */
        #image-upload-area {
            border: 3px dashed #007bff; /* ä½¿ç”¨è—è‰²è™›ç·šæ¡† */
            background-color: #e6f7ff; /* æ¥µæ·ºè—è‰²èƒŒæ™¯ */
            padding: 25px;
            margin: 20px auto;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #image-upload-area:hover {
            background-color: #cceeff;
        }

        /* éš±è—åŸç”Ÿæª”æ¡ˆè¼¸å…¥æ¡† */
        #fileInput {
            display: none;
        }

        /* åœ–ç‰‡é è¦½æ¡† (æ²¿ç”¨ cam-frame çš„è¦–è¦ºé¢¨æ ¼) */
        #image-preview {
            max-width: 100%;
            max-height: 350px;
            margin: 20px auto;
            border: 4px solid #333; /* æ·±è‰²é‚Šæ¡† */
            border-radius: 4px;
            display: none; /* é è¨­éš±è— */
            object-fit: contain;
            background-color: #000;
        }
        
        /* çµæœå±•ç¤ºå€ */
        .result-box {
            background: #fff;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .result-box strong {
            font-size: 1.5em;
            color: #ff6600; /* ä½¿ç”¨æ©™è‰²çªå‡ºçµæœ */
        }

        /* åŠŸèƒ½æŒ‰éˆ• (è¾¨è­˜/å„²å­˜) */
        .action-button {
            background-color: #ff6600; /* æ©™è‰²æŒ‰éˆ•ï¼Œç”¨æ–¼ä¸»è¦å‹•ä½œ */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            margin: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .action-button:hover:not(:disabled) {
            background-color: #cc5200;
        }

        .action-button:disabled {
            background-color: #5a5a5a; /* é—œé–‰ç‹€æ…‹çš„ç°è‰² */
            cursor: not-allowed;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 680px) {
            .container {
                margin: 0;
            }
            #image-preview {
                width: 100%;
            }
        }
        /* === å°ˆå±¬æ¨£å¼ End === */

    </style>
</head>
<body>
    <div class="container">
        
        <button class="back-button" onclick="history.back()">
            â† è¿”å›ä¸Šä¸€é 
        </button>
        
        <h1>è¡€å£“è¨ˆå½±åƒè¾¨è­˜èˆ‡æ•¸æ“šè¨˜éŒ„</h1>
        
        <p>è«‹ä¸Šå‚³è¡€å£“è¨ˆé¡¯ç¤ºå±çš„åœ–ç‰‡ã€‚</p>
        <hr>

        <div class="recognition-section">
            <h2>ä¸Šå‚³åœ–ç‰‡</h2>
            
            <input type="file" id="fileInput" accept="image/*" onchange="previewImage()">
            
            <div id="image-upload-area" onclick="document.getElementById('fileInput').click()">
                <p>é»æ“Šä¸Šå‚³è¡€å£“è¨ˆåœ–ç‰‡</p>
            </div>
            
            <img id="image-preview" src="#" alt="ä¸Šå‚³çš„åœ–ç‰‡é è¦½">
            
            <button class="action-button" id="predict-button" onclick="predict()" disabled>
                ğŸ§  é–‹å§‹è¾¨è­˜æ•¸å€¼
            </button>
            <p style="font-size: 0.9em; color: #888;">è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼Œå†é»æ“Šé–‹å§‹è¾¨è­˜ã€‚</p>
            <hr>

            <h2>è¾¨è­˜çµæœèˆ‡è¨˜éŒ„</h2>
            
            <div class="result-box">
                <p>æ”¶ç¸®å£“ (Systolic): <strong id="systolic-result">---</strong> mmHg</p>
                <p>èˆ’å¼µå£“ (Diastolic): <strong id="diastolic-result">---</strong> mmHg</p>
            </div>
            
            <button class="action-button" id="save-button" onclick="saveToSheet()" disabled>
                ğŸ’¾ è¨˜éŒ„åˆ° Google Sheet
            </button>

        </div>

    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    
    <script>
        // ----------------------------------------------------------------------
        // ã€æ ¸å¿ƒè¨­å®šå€ã€‘è«‹å‹™å¿…æ›¿æ›
        // ----------------------------------------------------------------------
        // ğŸš¨ 1. Teachable Machine æ¨¡å‹çš„ URL (è«‹æ›¿æ›ç‚ºæ‚¨è‡ªå·±çš„æ¨¡å‹ç¶²å€) ğŸš¨
        const URL = "https://teachablemachine.withgoogle.com/models/UGwLtPbgm/"; // å‡è¨­æ‚¨å°‡æ¨¡å‹æ–‡ä»¶å¤¾å‘½åç‚º my_model

        // ğŸš¨ 2. è£å‰ªå€åŸŸå®šç¾© (x, y, w, h ä»£è¡¨æ•¸å­—åœ¨åœ–ç‰‡ä¸­çš„åº§æ¨™å’Œå°ºå¯¸) ğŸš¨
        // *è«‹å‹™å¿…æ ¹æ“šæ‚¨çš„è¡€å£“è¨ˆè¢å¹•ä½ç½®é€²è¡Œèª¿æ•´ï¼*
        const CROP_AREAS = [
            // æ”¶ç¸®å£“ (Systolic) - å‡è¨­æ˜¯ä¸‰ä½æ•¸ (e.g., 120)
            { id: "SYS_1", type: "S", x: 100, y: 150, w: 40, h: 60 }, // æ”¶ç¸®å£“ ç¬¬ä¸€ä½
            { id: "SYS_2", type: "S", x: 145, y: 150, w: 40, h: 60 }, // æ”¶ç¸®å£“ ç¬¬äºŒä½
            { id: "SYS_3", type: "S", x: 190, y: 150, w: 40, h: 60 }, // æ”¶ç¸®å£“ ç¬¬ä¸‰ä½

            // èˆ’å¼µå£“ (Diastolic) - å‡è¨­æ˜¯å…©ä½æ•¸ (e.g., 80)
            { id: "DIA_1", type: "D", x: 100, y: 220, w: 40, h: 60 }, // èˆ’å¼µå£“ ç¬¬ä¸€ä½
            { id: "DIA_2", type: "D", x: 145, y: 220, w: 40, h: 60 }, // èˆ’å¼µå£“ ç¬¬äºŒä½

            // å¦‚æœæœ‰è„ˆæ (Pulse)ï¼Œè«‹è‡ªè¡ŒåŠ å…¥ { id: "PUL_1", type: "P", x: ..., y: ..., w: ..., h: ... },
        ];
        // ----------------------------------------------------------------------


        let model, maxPredictions;
        const DEFAULT_VALUE = "---"; 
        
        // å»ºç«‹ä¸€å€‹éš±è—çš„ Canvas ä¾›è£å‰ªå’Œé æ¸¬ä½¿ç”¨
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = 224; // é è¨­ Teachable Machine è¼¸å…¥å°ºå¯¸
        tempCanvas.height = 224;
        const tempCtx = tempCanvas.getContext('2d');
        

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–æ¨¡å‹
        async function init() {
            try {
                const modelURL = URL + "model.json";
                const metadataURL = URL + "metadata.json";

                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();
                
                document.getElementById('systolic-result').innerText = DEFAULT_VALUE;
                document.getElementById('diastolic-result').innerText = DEFAULT_VALUE;
                console.log("Teachable Machine æ¨¡å‹è¼‰å…¥å®Œæˆã€‚");
                // é€™è£¡å¯ä»¥åŠ å…¥æç¤ºï¼Œä¾‹å¦‚ï¼šæ¨¡å‹è¼‰å…¥æˆåŠŸï¼Œè«‹ä¸Šå‚³åœ–ç‰‡
                
            } catch (error) {
                console.error("æ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ URL åŠæª”æ¡ˆè·¯å¾‘: ", error);
                document.getElementById('systolic-result').innerText = "è¼‰å…¥å¤±æ•—";  
                document.getElementById('diastolic-result').innerText = "è¼‰å…¥å¤±æ•—";
                alert("AIæ¨¡å‹è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Teachable Machine URL å’Œæª”æ¡ˆè·¯å¾‘æ˜¯å¦æ­£ç¢ºã€‚");
            }
        }

        // åœ–ç‰‡ä¸Šå‚³é è¦½ (é€™éƒ¨åˆ†é‚è¼¯ä¸è®Šï¼Œä¿æŒæ‚¨åŸæœ¬çš„ code)
        function previewImage() {
            const fileInput = document.getElementById('fileInput');
            const preview = document.getElementById('image-preview');
            const file = fileInput.files[0];

            document.getElementById("predict-button").disabled = true;  
            document.getElementById("save-button").disabled = true;
            document.getElementById("predict-button").innerText = "ğŸ§  é–‹å§‹è¾¨è­˜æ•¸å€¼";

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    document.getElementById("predict-button").disabled = false;  
                    document.getElementById("systolic-result").innerText = DEFAULT_VALUE;
                    document.getElementById("diastolic-result").innerText = DEFAULT_VALUE;
                }
                reader.readAsDataURL(file);
            }
        }

        // æ ¸å¿ƒè¾¨è­˜å‡½å¼ (å·²æ•´åˆ AI é‚è¼¯)
        async function predict() {
            document.getElementById("predict-button").innerText = "è¾¨è­˜ä¸­...";
            document.getElementById("predict-button").disabled = true;
            document.getElementById("systolic-result").innerText = "åˆ†æä¸­...";
            document.getElementById("diastolic-result").innerText = "åˆ†æä¸­...";
            document.getElementById("save-button").disabled = true;

            if (!model) {
                alert("æ¨¡å‹å°šæœªè¼‰å…¥æˆåŠŸï¼Œç„¡æ³•è¾¨è­˜ã€‚");
                document.getElementById("predict-button").innerText = "ğŸ§  æ¨¡å‹æœªè¼‰å…¥";
                document.getElementById("predict-button").disabled = false;
                document.getElementById("systolic-result").innerText = "è¼‰å…¥å¤±æ•—";
                document.getElementById("diastolic-result").innerText = "è¼‰å…¥å¤±æ•—";
                return;
            }

            const image = document.getElementById('image-preview');
            if (!image.src || image.src.includes('#')) {
                alert("è«‹å…ˆä¸Šå‚³åœ–ç‰‡ï¼");
                document.getElementById("predict-button").innerText = "ğŸ§  é–‹å§‹è¾¨è­˜æ•¸å€¼";
                document.getElementById("predict-button").disabled = false;
                document.getElementById("systolic-result").innerText = DEFAULT_VALUE;
                document.getElementById("diastolic-result").innerText = DEFAULT_VALUE;
                return;
            }

            // 1. å»ºç«‹ä¸€å€‹ Canvas ä¾†è™•ç†åŸå§‹åœ–ç‰‡
            const originalCanvas = document.createElement('canvas');
            originalCanvas.width = image.naturalWidth;
            originalCanvas.height = image.naturalHeight;
            const originalCtx = originalCanvas.getContext('2d');
            originalCtx.drawImage(image, 0, 0, image.naturalWidth, image.naturalHeight);
            
            let systolicStr = "";
            let diastolicStr = "";
            let isSuccessful = true;
            
            try {
                for (const area of CROP_AREAS) {
                    // 2. è£å‰ªå–®å€‹æ•¸å­—çš„å€åŸŸ (ä½¿ç”¨åŸå§‹åœ–ç‰‡çš„ Canvas)
                    // å¾åŸåœ–ä¸­æŠ“å–åƒç´ æ•¸æ“š
                    const croppedImageData = originalCtx.getImageData(area.x, area.y, area.w, area.h);
                    
                    // 3. å°‡è£å‰ªçš„æ•¸å­—ç¹ªè£½åˆ°è‡¨æ™‚ Canvasï¼Œä¸¦ç¸®æ”¾è‡³ 224x224 (æ¨¡å‹æ‰€éœ€çš„å°ºå¯¸)
                    // ç”±æ–¼ tmImage.predict å‡½å¼é æœŸè¼¸å…¥çš„æ˜¯ 224x224ï¼Œé€™è£¡æˆ‘å€‘ä½¿ç”¨ç¹ªåœ–ä¸¦ç¸®æ”¾ã€‚
                    tempCtx.clearRect(0, 0, 224, 224);
                    const tempImg = new Image();
                    tempImg.src = URL.createObjectURL(new Blob([tempCanvas.toBlob(blob => {
                        // ç°¡å–®å°‡è£å‰ªæ•¸æ“šè½‰ç‚º Blob (é€™æ­¥æ“ä½œè¼ƒè¤‡é›œï¼Œç°¡åŒ–ç‚ºç›´æ¥ä½¿ç”¨ tmImage.predict è™•ç† ImageData è¼ƒä½³)
                        // é€™è£¡ç‚ºäº†è®“ç¨‹å¼ç¢¼æ›´ç²¾ç°¡ï¼Œæˆ‘å€‘ä½¿ç”¨ tmImage.predict çš„å½ˆæ€§
                        // å¯¦éš›æ“ä½œä¸Šï¼Œç›´æ¥å°‡è£å‰ªå¾Œçš„åœ–åƒæ•¸æ“šè½‰ç‚º 224x224 çš„ tensor è¼ƒç‚ºåš´è¬¹ã€‚
                        
                        // æˆ‘å€‘é€™è£¡æ¡å–æ›´ç°¡å–®ä½†æ›´ä¾è³´ tmImage/TF.js å½ˆæ€§çš„æ–¹æ³•ï¼š
                        // å°‡è£å‰ªå€åŸŸç›´æ¥ç¹ªè£½åˆ°ä¸€å€‹æ–°çš„ Canvas (å°ºå¯¸ç‚ºè£å‰ªå°ºå¯¸)ï¼Œå†è®“æ¨¡å‹è™•ç†ã€‚
                        const digitCanvas = document.createElement('canvas');
                        digitCanvas.width = area.w;
                        digitCanvas.height = area.h;
                        digitCanvas.getContext('2d').putImageData(croppedImageData, 0, 0);
                        
                        return digitCanvas;
                    }, 'image/png')]));

                    // 4. åŸ·è¡Œé æ¸¬
                    const prediction = await model.predict(digitCanvas);

                    // æ‰¾å‡ºä¿¡å¿ƒåº¦æœ€é«˜çš„é¡åˆ¥
                    const highestPrediction = prediction.reduce((prev, current) => 
                        (prev.probability > current.probability) ? prev : current
                    );
                    
                    // æ•¸å­—é¡åˆ¥åç¨±æ‡‰è©²æ˜¯ "0", "1", "2", ...
                    const predictedDigit = highestPrediction.className; 
                    
                    // 5. çµ„è£æ•¸å€¼
                    if (predictedDigit !== undefined && highestPrediction.probability > 0.7) { // è¨­ç½®ä¿¡å¿ƒåº¦é–¾å€¼
                        if (area.type === "S") {
                            systolicStr += predictedDigit;
                        } else if (area.type === "D") {
                            diastolicStr += predictedDigit;
                        }
                    } else {
                        console.warn(`è¾¨è­˜é …ç›® ${area.id} ä¿¡å¿ƒåº¦ä¸è¶³ (${(highestPrediction.probability * 100).toFixed(1)}%)ï¼Œè¨­ç‚ºå¤±æ•—ã€‚`);
                        isSuccessful = false;
                        break; // åªè¦ä¸€å€‹æ•¸å­—å¤±æ•—ï¼Œæ•´å€‹çµæœè¦–ç‚ºå¤±æ•—
                    }
                }

            } catch (error) {
                console.error("è¾¨è­˜éç¨‹ç™¼ç”ŸéŒ¯èª¤:", error);
                isSuccessful = false;
            }

            // 6. é¡¯ç¤ºçµæœ
            const finalSystolic = isSuccessful && systolicStr.length > 0 ? systolicStr : DEFAULT_VALUE;
            const finalDiastolic = isSuccessful && diastolicStr.length > 0 ? diastolicStr : DEFAULT_VALUE;

            document.getElementById("systolic-result").innerText = finalSystolic;
            document.getElementById("diastolic-result").innerText = finalDiastolic;

            // æ¢å¾©æŒ‰éˆ•
            const successText = `âœ… è¾¨è­˜æˆåŠŸ (${finalSystolic}/${finalDiastolic})`;
            const failureText = `âŒ è¾¨è­˜å¤±æ•—ï¼Œè«‹é‡è©¦`;
            document.getElementById("predict-button").innerText = isSuccessful && finalSystolic !== DEFAULT_VALUE ? successText : failureText;
            document.getElementById("predict-button").disabled = false;
            
            // å•Ÿç”¨/ç¦ç”¨å„²å­˜æŒ‰éˆ•
            if (finalSystolic !== DEFAULT_VALUE && finalDiastolic !== DEFAULT_VALUE) {
                document.getElementById("save-button").disabled = false;
            } else {
                document.getElementById("save-button").disabled = true;
            }
        }

        // è³‡æ–™å¯«å…¥ Google Sheet å‡½å¼ (ä¿æŒæ‚¨åŸæœ¬çš„é‚è¼¯ï¼Œä½† GOOGLE_SCRIPT_URL éœ€æ›¿æ›)
        function saveToSheet() {
            const systolicRaw = document.getElementById("systolic-result").innerText.trim();
            const diastolicRaw = document.getElementById("diastolic-result").innerText.trim();

            const systolic = Number(systolicRaw);  
            const diastolic = Number(diastolicRaw);  

            if (systolicRaw === DEFAULT_VALUE || diastolicRaw === DEFAULT_VALUE || isNaN(systolic) || isNaN(diastolic)) {
                alert("è¾¨è­˜æ•¸å€¼ç„¡æ•ˆæˆ–æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•å„²å­˜ã€‚");
                return;
            }

            document.getElementById("save-button").innerText = "å„²å­˜ä¸­...";
            document.getElementById("save-button").disabled = true;
            
            // ğŸš¨ è«‹æ›¿æ›ç‚ºæ‚¨ Google Apps Script çš„ Web App URL ğŸš¨
            const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyRizxiYrgd2WDhDLLeU1-UrkIiWkFTwHcHf8ANkyCDTnET1mhfbXLQwpfQn3-tZsFL/exec'; // é€™æ˜¯ç¤ºä¾‹ URL
            
            const data = {
                'timestamp': new Date().toLocaleString(),
                'systolic': systolic,  
                'diastolic': diastolic
            };

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',  
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(() => {
                setTimeout(() => {
                    alert("è¡€å£“æ•¸æ“šå·²æˆåŠŸè¨˜éŒ„åˆ° Google Sheetï¼");
                    document.getElementById("save-button").innerText = "ğŸ’¾ è¨˜éŒ„å®Œæˆ";
                    document.getElementById("save-button").disabled = true;
                }, 500); 

            })
            .catch(error => {
                console.error('è¨˜éŒ„å¤±æ•—:', error);
                alert("æ•¸æ“šè¨˜éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– Apps Script URLã€‚");
                document.getElementById("save-button").innerText = "ğŸ’¾ è¨˜éŒ„å¤±æ•—";
                document.getElementById("save-button").disabled = false;
            });
        }

        // å•Ÿå‹•æ¨¡å‹è¼‰å…¥
        init();
    </script>
</body>
</html>
